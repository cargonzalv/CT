# TASK: explode-pr-metadata
# AUTHOR: Vincent Foley
# DESCRIPTION: Takes the values from the file `metadata.json`
#   generated by telia-oss/github-pr-resource's and writes it
#   into files named after the key.  Example:
#
#   out/author:gnuvince
#   out/base_name:master
#   out/base_sha:197d32ad1abb2c4da23bd01a878c777e4264da00
#   out/head_name:explode
#   out/head_sha:43ac73d2af7db8faa482cffe4166f679ab460cf8
#   out/message:Use \x1c to indicate a new file
#   out/pr:37
#   out/url:https://github.com/adgear/jenny/pull/37
#
# CAVEATS: Fails if a line in a value of `metadata.json` starts
#   with the string "\x1c ".

---
platform: linux
image_resource:
  type: docker-image
  source:
    repository: alpine

run:
  path: /bin/sh
  args:
    - -c
    - |
      apk add jq
      cat in/.git/resource/metadata.json | jq -cr '.[] | ("\u001c out/" + .name, .value)' | awk '$1 == "\x1c" { filename = $2 } $1 != "\x1c" { print $0 >>filename }'
      tr -c -- '-_.a-zA-Z0-9\n' - <out/head_name >out/head_name_safe
      grep -H '' out/*

inputs:
  - name: in
outputs:
  - name: out
